# time_series_analysis-2-


import pandas as pd
from prophet import Prophet
import io
import plotly.graph_objects as go
from sklearn.metrics import mean_absolute_error, mean_absolute_percentage_error
import numpy as np

# 1. Ваши данные (еженедельные)
data = """fd,m
1,2021-01-10
1,2021-01-17
0,2021-01-24
0,2021-01-31
1,2021-02-21
1,2021-03-07
1,2021-04-25
1,2021-10-10
2,2021-11-07
0,2021-11-14
1,2021-12-12
1,2022-01-30
1,2022-02-13
1,2022-04-17
1,2022-04-24
6,2022-05-01
0,2022-05-08
2,2022-05-15
0,2022-05-22
0,2022-05-29
1,2022-06-05
3,2022-07-10
0,2022-08-07
1,2022-08-14
1,2022-08-21
0,2022-08-28
1,2022-09-04
2,2022-09-11
7,2022-09-25
4,2022-10-02
1,2022-10-09
3,2022-10-16
4,2022-10-23
1,2022-10-30
2,2022-11-06
3,2022-11-13
1,2022-11-20
1,2022-11-27
5,2022-12-04
6,2022-12-11
1,2022-12-18
2,2022-12-25
1,2023-01-01
2,2023-01-08
5,2023-01-15
1,2023-01-22
3,2023-01-29
13,2023-02-05
16,2023-02-12
21,2023-02-19
9,2023-02-26
8,2023-03-05
15,2023-03-12
17,2023-03-19
21,2023-03-26
15,2023-04-02
12,2023-04-09
12,2023-04-16
18,2023-04-23
19,2023-04-30
12,2023-05-07
8,2023-05-14
8,2023-05-21
7,2023-05-28
18,2023-06-04
18,2023-06-11
11,2023-06-18
7,2023-06-25
24,2023-07-02
30,2023-07-09
53,2023-07-16
71,2023-07-23
122,2023-07-30
124,2023-08-06
131,2023-08-13
89,2023-08-20
107,2023-08-27
200,2023-09-03
117,2023-09-10
83,2023-09-17
129,2023-09-24
200,2023-10-01
396,2023-10-08
1421,2023-10-15
446,2023-10-22
312,2023-10-29
252,2023-11-05
275,2023-11-12
304,2023-11-19
191,2023-11-26
219,2023-12-03
203,2023-12-10
167,2023-12-17
174,2023-12-24
159,2023-12-31
231,2024-01-07
232,2024-01-14
404,2024-01-21
480,2024-01-28
621,2024-02-04
554,2024-02-11
505,2024-02-18
466,2024-02-25
709,2024-03-03
778,2024-03-10
649,2024-03-17
622,2024-03-24
666,2024-03-31
745,2024-04-07
556,2024-04-14
338,2024-04-21
315,2024-04-28
365,2024-05-05
337,2024-05-12
393,2024-05-19
536,2024-05-26
582,2024-06-02
568,2024-06-09
534,2024-06-16
455,2024-06-23
343,2024-06-30
240,2024-07-07
260,2024-07-14
270,2024-07-21
245,2024-07-28
342,2024-08-04
317,2024-08-11
354,2024-08-18
310,2024-08-25
646,2024-09-01
426,2024-09-08
198,2024-09-15
184,2024-09-22
211,2024-09-29
312,2024-10-06
236,2024-10-13
238,2024-10-20
195,2024-10-27
224,2024-11-03
233,2024-11-10
271,2024-11-17
299,2024-11-24
332,2024-12-01
287,2024-12-08
237,2024-12-15
276,2024-12-22
464,2024-12-29
621,2025-01-05
644,2025-01-12
691,2025-01-19
601,2025-01-26
842,2025-02-02
711,2025-02-09
840,2025-02-16
686,2025-02-23
703,2025-03-02
754,2025-03-09
693,2025-03-16
709,2025-03-23
694,2025-03-30
649,2025-04-06
662,2025-04-13
818,2025-04-20
848,2025-04-27
644,2025-05-04
744,2025-05-11
1197,2025-05-18
1114,2025-05-25
1269,2025-06-01
1180,2025-06-08
1383,2025-06-15
1736,2025-06-22
2294,2025-06-29
2245,2025-07-06
1767,2025-07-13
2253,2025-07-20
1438,2025-07-27
1931,2025-08-03
1483,2025-08-10
1295,2025-08-17
1578,2025-08-24
2297,2025-08-31
3000,2025-09-07
3528,2025-09-14
1760,2025-09-21
1581,2025-09-28
1642,2025-10-05
165,2025-10-12
"""

# 2. Подготовка данных
df = pd.read_csv(io.StringIO(data))
df.columns = ['y', 'ds']
df['ds'] = pd.to_datetime(df['ds'])
df = df.sort_values('ds').reset_index(drop=True)

TRAINING_CUTOFF_DATE = '2025-05-01'

# --- ИЗМЕНЕНИЕ 1: ДОБАВЛЯЕМ РЕГРЕССОР ---
# Создаем колонку 'influencer_active'.
# Ставим 1 для всех дат, когда инфлюенсер был активен.
df['influencer_active'] = (df['ds'] >= pd.to_datetime('2025-05-01')).astype(int)
# ----------------------------------------

# Разделяем данные на обучающую выборку
train_df = df[df['ds'] < TRAINING_CUTOFF_DATE]

# 3. Обучение модели
model = Prophet(weekly_seasonality=True)

# --- ИЗМЕНЕНИЕ 1 (продолжение): РЕГИСТРИРУЕМ РЕГРЕССОР ---
# Сообщаем модели, что нужно использовать эту колонку как дополнительный фактор
model.add_regressor('influencer_active')
# ----------------------------------------------------

model.fit(train_df)

# 4. Создание прогноза
# ВАЖНО: DataFrame, который мы передаем в predict, должен содержать колонку регрессора
forecast = model.predict(df[['ds', 'influencer_active']])

# --- ИЗМЕНЕНИЕ 2: РАСЧЕТ И ВЫВОД РАЗНИЦЫ ---
# 5. Соединяем факт и прогноз в одну таблицу
comparison_df = forecast.merge(df, on='ds')

comparison_df['yhat'] = round(comparison_df['yhat'], 0)
# Рассчитываем разницу: Факт минус Прогноз.
# Это число показывает, насколько реальность превзошла (или оказалась ниже) прогноза.
comparison_df['difference'] = comparison_df['y'] - comparison_df['yhat']

# Отфильтровываем только период прогнозирования
results_df = comparison_df[comparison_df['ds'] >= TRAINING_CUTOFF_DATE]

print("--- Разница между фактом и прогнозом по неделям ---")
print(results_df[['ds', 'y', 'yhat', 'difference']].round(2))
print("--------------------------------------------------")
# Где 'y' - ваш факт, 'yhat' - прогноз модели, 'difference' - их разница.
# Положительное число в 'difference' означает, что факт оказался выше прогноза.

# 6. Визуализация (код не изменился)
fig = go.Figure()
fig.add_trace(go.Scatter(x=df['ds'], y=df['y'], mode='markers', marker=dict(color='black', size=6), name='Факт'))
fig.add_trace(go.Scatter(x=forecast['ds'], y=forecast['yhat'], mode='lines', line=dict(color='blue', width=2), name='Прогноз'))
fig.add_trace(go.Scatter(x=forecast['ds'], y=forecast['yhat_upper'], mode='lines', line=dict(width=0), hoverinfo="skip", showlegend=False))
fig.add_trace(go.Scatter(x=forecast['ds'], y=forecast['yhat_lower'], mode='lines', line=dict(width=0), fillcolor='rgba(0, 100, 255, 0.2)', fill='tonexty', hoverinfo="skip", showlegend=False, name='Доверительный интервал'))
fig.add_shape(type="line", x0=TRAINING_CUTOFF_DATE, y0=0, x1=TRAINING_CUTOFF_DATE, y1=1, yref="paper", line=dict(color="grey", width=2, dash="dash"))
fig.add_annotation(x=TRAINING_CUTOFF_DATE, y=0.95, yref="paper", text="Начало кампании", showarrow=False, xanchor="left")
fig.update_layout(title='Сравнение фактических данных с прогнозом Prophet', xaxis_title='Дата', yaxis_title='Количество первых депозитов', legend_title_text='Данные', hovermode="x unified")
fig.show()
